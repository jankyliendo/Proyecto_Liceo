<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiceoConnect - Sistema Integral</title>
    
    <!-- Librerías Externas -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .cal-day:hover { background-color: #eff6ff; }
        .has-note::after { content: ''; display: block; width: 6px; height: 6px; background-color: #2563eb; border-radius: 50%; margin: 2px auto 0; }
    </style>

    <!-- CONFIGURACIÓN DE FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, setDoc, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CREDENCIALES
        const firebaseConfig = {
            apiKey: "AIzaSyBTBakt7BMojntmp_BVXQFXE4423g_D9II",
            authDomain: "liceofidel-8ba6b.firebaseapp.com",
            projectId: "liceofidel-8ba6b",
            storageBucket: "liceofidel-8ba6b.firebasestorage.app",
            messagingSenderId: "46843833096",
            appId: "1:46843833096:web:52356b55305d3d7a8e1abd"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            window.db = db;
            window.fs = { collection, getDocs, addDoc, updateDoc, doc, setDoc, query, where };
            console.log("Firebase inicializado correctamente.");
        } catch (e) {
            console.error("Error init Firebase:", e);
            alert("Error de configuración de Firebase.");
        }
    </script>
</head>

<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, createContext, useContext, useMemo } = React;

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-red-50 p-4">
                            <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full border border-red-100 text-center">
                                <h1 className="text-2xl font-bold text-red-600 mb-4">¡Ups! Algo salió mal</h1>
                                <button onClick={() => window.location.reload()} className="bg-red-600 text-white px-4 py-2 rounded-lg w-full font-bold">Recargar Página</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- COMPONENTES UI ---
        const LucideIcon = ({ name, className = "", size = 24 }) => {
            const svgHtml = useMemo(() => {
                if (window.lucide && window.lucide.icons && window.lucide.icons[name]) {
                    return window.lucide.icons[name].toSvg({ class: className, width: size, height: size });
                }
                return null;
            }, [name, className, size]);
            return svgHtml ? <span dangerouslySetInnerHTML={{ __html: svgHtml }} className="inline-flex" /> : <span>?</span>;
        };

        const Button = ({ children, onClick, disabled, className = "", variant="primary" }) => {
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700",
                secondary: "bg-white text-slate-700 border border-slate-300 hover:bg-slate-50",
                danger: "bg-red-500 text-white hover:bg-red-600"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`px-4 py-2 rounded-lg font-medium transition-all flex items-center justify-center gap-2 disabled:opacity-50 ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Input = ({ label, ...props }) => (
            <div className="mb-3">
                <label className="block text-xs font-bold text-slate-500 mb-1 uppercase">{label}</label>
                <input className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" {...props} />
            </div>
        );

        const Card = ({ title, children, className="" }) => (
            <div className={`bg-white p-6 rounded-xl shadow-sm border border-slate-200 ${className}`}>
                {title && <h3 className="text-lg font-bold text-slate-800 mb-4">{title}</h3>}
                {children}
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md animate-slide-in overflow-hidden">
                        <div className="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-lg">{title}</h3>
                            <button onClick={onClose}><LucideIcon name="x" className="text-slate-400 hover:text-red-500"/></button>
                        </div>
                        <div className="p-6 max-h-[80vh] overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };

        // --- CONTEXTOS ---
        const ToastContext = createContext();
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const addToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 4000);
            };
            return (
                <ToastContext.Provider value={{ addToast }}>
                    {children}
                    <div className="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none">
                        {toasts.map(t => (
                            <div key={t.id} className={`pointer-events-auto px-4 py-3 rounded-lg shadow-lg text-white font-medium flex items-center gap-2 ${t.type === 'error' ? 'bg-red-500' : 'bg-emerald-500'}`}>
                                <LucideIcon name={t.type === 'error' ? 'alert-circle' : 'check-circle'} size={20} className="text-white"/> {t.message}
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };
        const useToast = () => useContext(ToastContext);

        const DataContext = createContext();
        const DataProvider = ({ children }) => {
            const [data, setData] = useState({ users: [], news: [], assignments: [], grades: [], subjects: [], sections: [], calendarNotes: [] });
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const load = async () => {
                    if (!window.db) { setTimeout(load, 500); return; }
                    try {
                        const { collection, getDocs } = window.fs;
                        const [users, news, assigns, grades, subjects, notes] = await Promise.all([
                            getDocs(collection(window.db, "users")),
                            getDocs(collection(window.db, "news")),
                            getDocs(collection(window.db, "assignments")),
                            getDocs(collection(window.db, "grades")),
                            getDocs(collection(window.db, "subjects")),
                            getDocs(collection(window.db, "calendar_notes"))
                        ]);

                        const sections = [];
                        ["1er", "2do", "3er", "4to", "5to"].forEach((y, i) => ["A","B","C","D"].forEach(l => sections.push({id: `${i+1}${l}`, name: `${y} Año "${l}"`})));
                        
                        const defaultSubjects = [{id:'s1', name:'Matemática'}, {id:'s2', name:'Física'}, {id:'s3', name:'Química'}, {id:'s4', name:'Biología'}, {id:'s5', name:'Inglés'}, {id:'s6', name:'Castellano'}, {id:'s7', name:'Historia'}];
                        const dbSubjects = subjects.docs.map(d => ({ id: d.id, ...d.data() }));

                        setData({
                            users: users.docs.map(d => ({id: d.id, ...d.data()})),
                            news: news.docs.map(d => ({id: d.id, ...d.data()})),
                            assignments: assigns.docs.map(d => ({id: d.id, ...d.data()})),
                            grades: grades.docs.map(d => ({id: d.id, ...d.data()})),
                            calendarNotes: notes.docs.map(d => ({id: d.id, ...d.data()})),
                            subjects: dbSubjects.length > 0 ? dbSubjects : defaultSubjects,
                            sections
                        });
                    } catch (e) { console.error(e); } finally { setLoading(false); }
                };
                load();
            }, []);

            const addUser = async (u) => { const r = await window.fs.addDoc(window.fs.collection(window.db, "users"), u); setData(p => ({...p, users: [...p.users, {...u, id: r.id}]})); };
            const addNews = async (n) => { const r = await window.fs.addDoc(window.fs.collection(window.db, "news"), n); setData(p => ({...p, news: [{...n, id: r.id}, ...p.news]})); };
            const assignTeacher = async (a) => { const r = await window.fs.addDoc(window.fs.collection(window.db, "assignments"), a); setData(p => ({...p, assignments: [...p.assignments, {...a, id: r.id}]})); };
            const updateGrade = async (g) => { 
                const id = `${g.studentId}_${g.subjectId}`; 
                await window.fs.setDoc(window.fs.doc(window.db, "grades", id), g);
                const ng = data.grades.filter(x => !(x.studentId===g.studentId && x.subjectId===g.subjectId));
                ng.push({...g, id}); setData(p => ({...p, grades: ng}));
            };
            const updateUser = async (u) => { const {id,...rest} = u; await window.fs.updateDoc(window.fs.doc(window.db, "users", id), rest); setData(p => ({...p, users: p.users.map(x => x.id===id ? u : x)})); };
            const updateSubject = async (s) => { setData(p => ({...p, subjects: p.subjects.map(x => x.id===s.id ? s : x)})); };
            const addCalendarNote = async (note) => { const r = await window.fs.addDoc(window.fs.collection(window.db, "calendar_notes"), note); setData(p => ({...p, calendarNotes: [...p.calendarNotes, {...note, id: r.id}]})); };

            return <DataContext.Provider value={{ data, loading, addUser, addNews, assignTeacher, updateGrade, updateUser, updateSubject, addCalendarNote }}>{children}</DataContext.Provider>;
        };

        const AuthContext = createContext();
        const AuthProvider = ({ children }) => {
            const { data, addUser } = useContext(DataContext);
            const [user, setUser] = useState(null);

            const login = (email, pass) => {
                if (email === "admin.123@gmail.com" && pass === "Admin#*17052005") {
                    setUser({ id: "master", role: "admin", name: "Director General", email });
                    return { success: true };
                }
                const found = data.users.find(u => u.email === email && u.password === pass);
                if (found) { setUser(found); return { success: true }; }
                return { success: false, message: "Credenciales incorrectas" };
            };

            const register = async (userData) => {
                if (data.users.some(u => u.email === userData.email)) return { success: false, message: "Correo registrado" };
                try { await addUser({ ...userData, createdAt: new Date().toISOString() }); return { success: true }; } catch (e) { return { success: false, message: "Error de conexión" }; }
            };

            return <AuthContext.Provider value={{ user, login, logout: () => setUser(null), register }}>{children}</AuthContext.Provider>;
        };

        // --- COMPONENTES NUEVOS ---
        
        // CALENDARIO UNIVERSAL (DOCENTE Y ESTUDIANTE)
        const UserCalendar = () => {
            const { data, addCalendarNote } = useContext(DataContext);
            const { user } = useContext(AuthContext);
            const { addToast } = useToast();
            
            const [date, setDate] = useState(new Date());
            const [selectedDay, setSelectedDay] = useState(null);
            const [noteContent, setNoteContent] = useState("");

            const year = date.getFullYear();
            const month = date.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            // Filtramos las notas para que el usuario SOLO vea las suyas
            const myNotes = data.calendarNotes.filter(n => n.userId === user.id);

            const handleSaveNote = async () => {
                if (!noteContent) return;
                const noteDate = `${year}-${month}-${selectedDay}`;
                await addCalendarNote({ userId: user.id, date: noteDate, content: noteContent });
                addToast("Nota guardada");
                setNoteContent("");
                setSelectedDay(null);
            };

            const getNotesForDay = (day) => {
                const noteDate = `${year}-${month}-${day}`;
                return myNotes.filter(n => n.date === noteDate);
            };

            return (
                <div className="space-y-6">
                    <Card>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-slate-800">{monthNames[month]} {year}</h2>
                            <div className="flex gap-2">
                                <Button variant="secondary" onClick={() => setDate(new Date(year, month - 1))} className="px-2"><LucideIcon name="chevron-left"/></Button>
                                <Button variant="secondary" onClick={() => setDate(new Date(year, month + 1))} className="px-2"><LucideIcon name="chevron-right"/></Button>
                            </div>
                        </div>
                        <div className="grid grid-cols-7 gap-2 text-center mb-2">
                            {['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'].map(d => <div key={d} className="text-xs font-bold text-slate-400 uppercase">{d}</div>)}
                        </div>
                        <div className="grid grid-cols-7 gap-2">
                            {[...Array(firstDay)].map((_, i) => <div key={`empty-${i}`}></div>)}
                            {[...Array(daysInMonth)].map((_, i) => {
                                const day = i + 1;
                                const notes = getNotesForDay(day);
                                const hasNotes = notes.length > 0;
                                return (
                                    <div 
                                        key={day} 
                                        onClick={() => setSelectedDay(day)}
                                        className={`cal-day h-20 border rounded-lg p-1 cursor-pointer flex flex-col items-center justify-start transition-colors relative ${selectedDay === day ? 'ring-2 ring-blue-500 bg-blue-50' : 'bg-white'}`}
                                    >
                                        <span className={`text-sm font-medium ${hasNotes ? 'text-blue-600' : 'text-slate-700'}`}>{day}</span>
                                        {hasNotes && <div className="mt-1 w-1.5 h-1.5 bg-blue-500 rounded-full"></div>}
                                        {hasNotes && <div className="text-[10px] text-slate-400 mt-1 truncate w-full px-1">{notes[0].content}</div>}
                                    </div>
                                );
                            })}
                        </div>
                    </Card>

                    <Modal isOpen={!!selectedDay} onClose={() => setSelectedDay(null)} title={`Notas del ${selectedDay}`}>
                        <div className="space-y-4">
                            <div className="space-y-2">
                                {selectedDay && getNotesForDay(selectedDay).map((n, idx) => (
                                    <div key={idx} className="bg-yellow-50 p-2 rounded border border-yellow-100 text-sm text-yellow-800">• {n.content}</div>
                                ))}
                                {selectedDay && getNotesForDay(selectedDay).length === 0 && <p className="text-sm text-gray-400 italic">No tienes notas para este día.</p>}
                            </div>
                            <hr className="border-slate-100"/>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Nueva Nota</label>
                                <textarea className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-200" rows="3" value={noteContent} onChange={e => setNoteContent(e.target.value)} placeholder="Ej: Entrega de tarea, Examen..."></textarea>
                            </div>
                            <Button className="w-full" onClick={handleSaveNote}>Guardar Nota</Button>
                        </div>
                    </Modal>
                </div>
            );
        };

        // --- VISTAS EXISTENTES ---
        const Login = () => {
            const { login } = useContext(AuthContext);
            const { addToast } = useToast();
            const [form, setForm] = useState({e:"", p:""});
            const sub = (e) => { e.preventDefault(); const r = login(form.e, form.p); r.success ? addToast("Bienvenido") : addToast(r.message, 'error'); };
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
                        <h1 className="text-2xl font-bold text-center mb-6 text-slate-800">LiceoConnect</h1>
                        <form onSubmit={sub}>
                            <Input label="Correo" type="email" onChange={e=>setForm({...form, e:e.target.value})} />
                            <Input label="Clave" type="password" onChange={e=>setForm({...form, p:e.target.value})} />
                            <Button type="submit" className="w-full mt-2">Entrar</Button>
                        </form>
                        <p className="mt-4 text-center text-sm"><a href="#register" className="text-blue-600 font-bold">Crear Cuenta</a></p>
                    </div>
                </div>
            );
        };

        const Register = () => {
            const { register, data } = useContext(AuthContext); 
            const { data: dbData } = useContext(DataContext);
            const { addToast } = useToast();
            const [role, setRole] = useState("student");
            const [form, setForm] = useState({});
            const [loading, setLoading] = useState(false);

            const sub = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    if(!window.db) throw new Error("No DB");
                    const res = await register({...form, role});
                    if(res.success) { addToast("Creado. Inicia sesión."); window.location.hash="login"; }
                    else addToast(res.message, 'error');
                } catch(e) { addToast("Error de conexión", 'error'); }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <h2 className="text-xl font-bold text-center mb-4">Registro</h2>
                        <div className="flex gap-2 mb-4 bg-slate-100 p-1 rounded-lg">
                            <button onClick={()=>setRole("student")} className={`flex-1 py-1 rounded text-sm font-bold ${role==="student"?"bg-white shadow":"text-slate-500"}`}>Alumno</button>
                            <button onClick={()=>setRole("teacher")} className={`flex-1 py-1 rounded text-sm font-bold ${role==="teacher"?"bg-white shadow":"text-slate-500"}`}>Docente</button>
                        </div>
                        <form onSubmit={sub}>
                            <Input label="Nombre" onChange={e=>setForm({...form, name:e.target.value})} required />
                            <Input label="Cédula" onChange={e=>setForm({...form, cedula:e.target.value})} required />
                            <Input label="Teléfono" onChange={e=>setForm({...form, phone:e.target.value})} required />
                            <Input label="Correo" type="email" onChange={e=>setForm({...form, email:e.target.value})} required />
                            <Input label="Clave" type="password" onChange={e=>setForm({...form, password:e.target.value})} required />
                            {role==="student" && <div className="mb-3"><label className="text-xs font-bold text-gray-500 uppercase">Sección</label><select className="w-full p-2 border rounded" onChange={e=>setForm({...form, sectionId:e.target.value})}><option value="">Elegir...</option>{dbData.sections.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}</select></div>}
                            {role==="student" && <Input label="Representante" onChange={e=>setForm({...form, representative:e.target.value})} />}
                            {role==="teacher" && <Input label="Materia" onChange={e=>setForm({...form, specialty:e.target.value})} />}
                            <Button type="submit" className="w-full mt-4" disabled={loading}>{loading ? "Guardando..." : "Registrarse"}</Button>
                        </form>
                        <p className="mt-4 text-center text-sm"><a href="#login" className="text-blue-600">Cancelar</a></p>
                    </div>
                </div>
            );
        };

        const DashboardLayout = ({ children, title, user, logout }) => {
            const [mobileMenu, setMobileMenu] = useState(false);
            const menus = {
                admin: [
                    {id:'dashboard', label:'Inicio', icon:'layout-dashboard'}, 
                    {id:'sections', label:'Asignar', icon:'users'}, 
                    {id:'students', label:'Alumnos', icon:'graduation-cap'},
                    {id:'teachers', label:'Docentes', icon:'briefcase'},
                    {id:'subjects', label:'Materias', icon:'book-open'},
                    {id:'news', label:'Noticias', icon:'bell'},
                    {id:'laws', label:'Leyes', icon:'scale'}
                ],
                teacher: [
                    {id:'dashboard', label:'Mis Secciones', icon:'layout-dashboard'},
                    {id:'calendar', label:'Calendario', icon:'calendar'}, 
                    {id:'news', label:'Cartelera', icon:'bell'},
                    {id:'laws', label:'Leyes', icon:'scale'}
                ],
                student: [
                    {id:'dashboard', label:'Inicio', icon:'home'},
                    {id:'calendar', label:'Calendario', icon:'calendar'}, // NUEVO PARA ESTUDIANTE
                    {id:'grades', label:'Boletín', icon:'file-text'},
                    {id:'news', label:'Noticias', icon:'bell'}, // NUEVO PARA ESTUDIANTE
                    {id:'profile', label:'Perfil', icon:'user'},
                    {id:'laws', label:'Leyes', icon:'scale'}
                ]
            };

            return (
                <div className="min-h-screen flex bg-slate-50">
                    <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-white border-r transform transition-transform lg:translate-x-0 ${mobileMenu?'translate-x-0':'-translate-x-full'}`}>
                        <div className="p-6 border-b flex items-center gap-3"><div className="bg-blue-600 p-2 rounded text-white"><LucideIcon name="graduation-cap"/></div><span className="font-bold text-lg">LiceoConnect</span></div>
                        <nav className="flex-1 p-4 space-y-1">{menus[user.role]?.map(m => <button key={m.id} onClick={()=>{window.location.hash=m.id;setMobileMenu(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium hover:bg-slate-50 ${window.location.hash.includes(m.id)?'bg-blue-50 text-blue-600':'text-slate-600'}`}><LucideIcon name={m.icon} size={18}/>{m.label}</button>)}</nav>
                        <div className="p-4 border-t"><button onClick={logout} className="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg"><LucideIcon name="log-out" size={16}/> Salir</button></div>
                    </aside>
                    <main className="flex-1 lg:ml-64 flex flex-col h-screen">
                        <header className="bg-white border-b h-16 flex items-center justify-between px-4"><button onClick={()=>setMobileMenu(!mobileMenu)} className="lg:hidden p-2"><LucideIcon name="menu"/></button><h1 className="font-bold text-slate-800">{title}</h1><div className="w-8"></div></header>
                        <div className="flex-1 overflow-y-auto p-4 lg:p-8"><div className="max-w-5xl mx-auto space-y-6">{children}</div></div>
                    </main>
                    {mobileMenu && <div className="fixed inset-0 bg-black/50 z-40 lg:hidden" onClick={()=>setMobileMenu(false)}></div>}
                </div>
            );
        };

        const AdminDashboard = () => {
            const { data } = useContext(DataContext);
            const stats = [
                { l: "Alumnos", v: data.users.filter(u => u.role === 'student').length, c: 'bg-blue-500', i: 'users' },
                { l: "Docentes", v: data.users.filter(u => u.role === 'teacher').length, c: 'bg-emerald-500', i: 'briefcase' },
                { l: "Secciones", v: data.sections.length, c: 'bg-purple-500', i: 'layers' },
                { l: "Materias", v: data.subjects.length, c: 'bg-orange-500', i: 'book' },
            ];
            return (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {stats.map((s, i) => <Card key={i} className="flex items-center gap-4"><div className={`${s.c} w-12 h-12 rounded-lg flex items-center justify-center text-white shadow-lg`}><LucideIcon name={s.i} /></div><div><p className="text-slate-500 text-sm">{s.l}</p><p className="text-2xl font-bold">{s.v}</p></div></Card>)}
                </div>
            );
        };

        const AdminSections = () => {
            const { data, assignTeacher } = useContext(DataContext);
            const { addToast } = useToast();
            const [sel, setSel] = useState({ section: data.sections[0]?.id, subject: data.subjects[0]?.name, teacher: "" });
            const handle = async () => { if(!sel.teacher) return; const t = data.users.find(u=>u.id===sel.teacher); await assignTeacher({ sectionId: sel.section, subject: sel.subject, teacherId: t.id, teacherName: t.name, subjectId: sel.subject }); addToast("Asignado"); };
            return (
                <Card title="Asignación de Carga">
                    <div className="grid md:grid-cols-3 gap-4 mb-6">
                        <div><label className="text-sm font-bold text-gray-500">Sección</label><select className="w-full p-2 border rounded" onChange={e=>setSel({...sel, section:e.target.value})}>{data.sections.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                        <div><label className="text-sm font-bold text-gray-500">Materia</label><select className="w-full p-2 border rounded" onChange={e=>setSel({...sel, subject:e.target.value})}>{data.subjects.map(s=><option key={s.id} value={s.name}>{s.name}</option>)}</select></div>
                        <div><label className="text-sm font-bold text-gray-500">Docente</label><div className="flex gap-2"><select className="w-full p-2 border rounded" onChange={e=>setSel({...sel, teacher:e.target.value})}><option value="">Seleccionar...</option>{data.users.filter(u=>u.role==='teacher').map(t=><option key={t.id} value={t.id}>{t.name}</option>)}</select><Button onClick={handle}>+</Button></div></div>
                    </div>
                    <div className="bg-slate-50 p-4 rounded"><h4 className="font-bold mb-2 text-blue-800">Asignaciones en esta sección:</h4><ul className="list-disc pl-4 text-sm">{data.assignments.filter(a=>a.sectionId===sel.section).map((a,i)=><li key={i}>{a.subject} - {a.teacherName}</li>)}</ul></div>
                </Card>
            );
        };

        const AdminList = ({ type }) => {
            const { data, updateUser } = useContext(DataContext);
            const { addToast } = useToast();
            const [edit, setEdit] = useState(null);
            const users = data.users.filter(u => u.role === type);
            const handleSave = async (e) => { e.preventDefault(); await updateUser(edit); setEdit(null); addToast("Actualizado"); };
            return (
                <div className="space-y-4">
                    <Card><table className="w-full text-sm text-left"><thead className="bg-slate-50 border-b"><tr><th className="p-3">Nombre</th><th className="p-3">Cédula</th><th className="p-3">Acción</th></tr></thead><tbody>{users.map(u=><tr key={u.id} className="border-b hover:bg-slate-50"><td className="p-3 font-medium">{u.name}</td><td className="p-3">{u.cedula}</td><td className="p-3"><button onClick={()=>setEdit(u)} className="text-blue-600"><LucideIcon name="pencil" size={16}/></button></td></tr>)}</tbody></table></Card>
                    <Modal isOpen={!!edit} onClose={()=>setEdit(null)} title="Editar Usuario">{edit && <form onSubmit={handleSave}><Input label="Nombre" value={edit.name} onChange={e=>setEdit({...edit, name:e.target.value})}/><Input label="Cédula" value={edit.cedula} onChange={e=>setEdit({...edit, cedula:e.target.value})}/><Button type="submit" className="w-full">Guardar</Button></form>}</Modal>
                </div>
            );
        };

        const AdminSubjects = () => {
            const { data, updateSubject } = useContext(DataContext);
            const { addToast } = useToast();
            const [edit, setEdit] = useState(null);
            const handleSave = async () => { await updateSubject(edit); setEdit(null); addToast("Actualizado"); };
            return (
                <Card title="Materias">
                    <div className="space-y-2">{data.subjects.map(s=><div key={s.id} className="flex justify-between p-3 border rounded items-center"><span>{s.name}</span><button onClick={()=>setEdit(s)} className="text-blue-600"><LucideIcon name="pencil" size={16}/></button></div>)}</div>
                    <Modal isOpen={!!edit} onClose={()=>setEdit(null)} title="Editar Materia">{edit && <><Input label="Nombre" value={edit.name} onChange={e=>setEdit({...edit, name:e.target.value})}/><Button className="w-full" onClick={handleSave}>Guardar</Button></>}</Modal>
                </Card>
            );
        };

        const StudentDashboard = () => {
            const { user } = useContext(AuthContext);
            const { data } = useContext(DataContext);
            const section = data.sections.find(s => s.id === user.sectionId);
            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-8 text-white shadow-lg">
                        <h2 className="text-3xl font-bold mb-2">Hola, {user.name.split(" ")[0]}!</h2>
                        <p className="text-blue-100">Sección: {section ? section.name : "Sin asignar"}</p>
                    </div>
                    <NewsFeed canPost={false} />
                </div>
            );
        };

        const StudentGrades = () => {
            const { data } = useContext(DataContext);
            const { user } = useContext(AuthContext);
            const myGrades = data.grades.filter(g => g.studentId === user.id);
            return <Card title="Boletín"><table className="w-full text-left"><thead className="bg-slate-100"><tr><th className="p-2">Materia</th><th className="p-2 text-center">Nota</th></tr></thead><tbody>{data.subjects.map(s=>{ const sc = myGrades.find(g => g.subjectId === s.name)?.score || "-"; return <tr key={s.id} className="border-t"><td className="p-3">{s.name}</td><td className={`p-3 text-center font-bold ${sc>=10?'text-blue-600':'text-red-500'}`}>{sc}</td></tr>})}</tbody></table></Card>;
        };

        const StudentProfile = () => {
            const { user } = useContext(AuthContext);
            const { updateUser, data } = useContext(DataContext);
            const { addToast } = useToast();
            const [form, setForm] = useState({...user});
            const handleSave = async () => { await updateUser(form); addToast("Perfil actualizado"); };
            return <Card title="Mi Perfil"><div className="grid md:grid-cols-2 gap-4"><div><label className="text-xs text-gray-500">Nombre</label><p className="font-bold bg-slate-50 p-2 rounded">{user.name}</p></div><div><label className="text-xs text-gray-500">Sección</label><p className="font-bold bg-slate-50 p-2 rounded">{data.sections.find(s=>s.id===user.sectionId)?.name}</p></div><Input label="Teléfono" value={form.phone} onChange={e=>setForm({...form, phone:e.target.value})}/><Input label="Dirección" value={form.address||""} onChange={e=>setForm({...form, address:e.target.value})}/></div><Button onClick={handleSave} className="w-full mt-4">Guardar</Button></Card>;
        };

        const TeacherGrades = () => {
            const { data, updateGrade } = useContext(DataContext);
            const { user } = useContext(AuthContext);
            const { addToast } = useToast();
            const [selAssign, setSelAssign] = useState(null);
            const myAssigns = data.assignments.filter(a => a.teacherId === user.id);

            if(!selAssign) {
                return (
                    <Card title="Mis Secciones Asignadas">
                        <div className="grid gap-4 sm:grid-cols-2">
                            {myAssigns.map((a,i) => (
                                <button key={i} onClick={()=>setSelAssign(a)} className="p-6 bg-white border rounded-xl text-left hover:border-blue-500 hover:shadow-md transition group">
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="bg-blue-100 p-2 rounded-lg text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition"><LucideIcon name="book"/></div>
                                        <LucideIcon name="chevron-right" className="text-slate-300"/>
                                    </div>
                                    <h4 className="font-bold text-lg text-slate-800">{a.subject}</h4>
                                    <p className="text-sm text-slate-500">{data.sections.find(s=>s.id===a.sectionId)?.name}</p>
                                </button>
                            ))}
                            {myAssigns.length === 0 && <div className="col-span-2 text-center py-10 text-slate-400 border-2 border-dashed rounded-xl">No tienes materias asignadas por la dirección.</div>}
                        </div>
                    </Card>
                );
            }

            const students = data.users.filter(u => u.role === 'student' && u.sectionId === selAssign.sectionId);

            return (
                <Card title={`Evaluando: ${selAssign.subject}`}>
                    <button onClick={()=>setSelAssign(null)} className="text-sm text-blue-600 mb-6 flex items-center gap-1 hover:underline"><LucideIcon name="arrow-left" size={16}/> Volver a mis secciones</button>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 border-b"><tr><th className="p-3">Estudiante</th><th className="p-3">Cédula</th><th className="p-3 w-32 text-center">Nota (0-20)</th></tr></thead>
                            <tbody className="divide-y">
                                {students.map(s => {
                                    const grade = data.grades.find(g => g.studentId === s.id && g.subjectId === selAssign.subject)?.score || "";
                                    return (
                                        <tr key={s.id} className="hover:bg-slate-50">
                                            <td className="p-3 font-medium">{s.name}</td>
                                            <td className="p-3 text-slate-500">{s.cedula}</td>
                                            <td className="p-3 text-center">
                                                <input 
                                                    type="number" min="0" max="20" 
                                                    className="w-16 p-2 border rounded text-center font-bold focus:ring-2 focus:ring-blue-500 outline-none" 
                                                    defaultValue={grade} 
                                                    onBlur={(e) => { updateGrade({ studentId: s.id, subjectId: selAssign.subject, score: e.target.value }); addToast("Nota guardada"); }} 
                                                />
                                            </td>
                                        </tr>
                                    )
                                })}
                            </tbody>
                        </table>
                    </div>
                </Card>
            );
        };

        const Laws = () => (
            <div className="space-y-6">
                <Card title="Marco Legal Institucional">
                    <div className="space-y-4">
                        <details className="group border rounded-lg p-4 open:bg-blue-50 transition-colors">
                            <summary className="font-bold cursor-pointer flex justify-between items-center text-slate-800">
                                Normas de Convivencia <LucideIcon name="chevron-down" size={16}/>
                            </summary>
                            <div className="mt-4 text-slate-600 text-sm space-y-2 pl-4 border-l-2 border-blue-200">
                                <p>1. Asistencia y Puntualidad: El horario de entrada es a las 7:00 AM.</p>
                                <p>2. Uniforme: Uso obligatorio del uniforme reglamentario.</p>
                                <p>3. Disciplina: Mantener el respeto hacia docentes y compañeros.</p>
                            </div>
                        </details>
                        <details className="group border rounded-lg p-4 open:bg-green-50 transition-colors">
                            <summary className="font-bold cursor-pointer flex justify-between items-center text-slate-800">
                                Ley Orgánica de Educación (LOE) <LucideIcon name="chevron-down" size={16}/>
                            </summary>
                            <div className="mt-4 text-slate-600 text-sm pl-4 border-l-2 border-green-200">
                                <p>Art. 3: La educación tiene como finalidad fundamental el pleno desarrollo de la personalidad.</p>
                            </div>
                        </details>
                        <details className="group border rounded-lg p-4 open:bg-purple-50 transition-colors">
                            <summary className="font-bold cursor-pointer flex justify-between items-center text-slate-800">
                                LOPNNA (Deberes y Derechos) <LucideIcon name="chevron-down" size={16}/>
                            </summary>
                            <div className="mt-4 text-slate-600 text-sm pl-4 border-l-2 border-purple-200">
                                <p><strong>Derecho al Buen Trato (Art. 32):</strong> Todos los niños tienen derecho al buen trato.</p>
                                <p><strong>Derecho a la Educación (Art. 53):</strong> Derecho a una educación gratuita y obligatoria.</p>
                            </div>
                        </details>
                    </div>
                </Card>
            </div>
        );

        const NewsFeed = ({ canPost }) => {
            const { data, addNews } = useContext(DataContext);
            const { user } = useContext(AuthContext);
            const { addToast } = useToast();
            const [post, setPost] = useState({ title: "", content: "" });
            
            const handle = async (e) => { 
                e.preventDefault(); 
                await addNews({ ...post, date: new Date().toLocaleDateString(), author: user.name, role: user.role }); 
                setPost({title:"", content:""}); 
                addToast("Publicado"); 
            };
            
            return (
                <div className="space-y-6">
                    {canPost && (
                        <Card>
                            <h3 className="font-bold mb-4 flex items-center gap-2"><LucideIcon name="megaphone" size={20} className="text-blue-600"/> Publicar Anuncio</h3>
                            <form onSubmit={handle}>
                                <Input label="Título" value={post.title} onChange={e => setPost({...post, title: e.target.value})} />
                                <div className="mb-4"><textarea className="w-full p-2 border rounded" placeholder="Escribe el comunicado..." rows="3" value={post.content} onChange={e => setPost({...post, content: e.target.value})}></textarea></div>
                                <Button type="submit">Publicar en Cartelera</Button>
                            </form>
                        </Card>
                    )}
                    
                    <h3 className="font-bold text-slate-800 text-lg">Cartelera Informativa</h3>
                    <div className="space-y-4">
                        {data.news.map(n => (
                            <Card key={n.id} className="border-l-4 border-blue-500">
                                <div className="flex justify-between items-start">
                                    <h4 className="font-bold text-lg text-slate-900">{n.title}</h4>
                                    <span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">{n.date}</span>
                                </div>
                                <p className="mt-2 text-slate-700 whitespace-pre-line">{n.content}</p>
                                <div className="mt-4 flex items-center gap-2 text-xs text-slate-400">
                                    <LucideIcon name="user" size={12}/>
                                    <span>Publicado por: {n.author} ({n.role === 'admin' ? 'Dirección' : 'Docente'})</span>
                                </div>
                            </Card>
                        ))}
                        {data.news.length === 0 && <p className="text-center text-slate-400 italic py-8">No hay noticias publicadas aún.</p>}
                    </div>
                </div>
            );
        };

        // --- APP ROOT ---
        const App = () => {
            const { user, logout } = useContext(AuthContext);
            const { loading } = useContext(DataContext);
            const [hash, setHash] = useState(window.location.hash.replace('#', '') || 'dashboard');

            useEffect(() => {
                const h = () => setHash(window.location.hash.replace('#', '') || 'dashboard');
                window.addEventListener('hashchange', h);
                return () => window.removeEventListener('hashchange', h);
            }, []);

            if (loading) return <div className="loading-screen"><div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div><p className="text-blue-600 font-bold animate-pulse">Conectando a Firebase...</p></div>;

            if (!user) return hash === 'register' ? <Register /> : <Login />;

            let content;
            if (user.role === 'admin') {
                if(hash === 'dashboard') content = <AdminDashboard />;
                else if(hash === 'sections') content = <AdminSections />;
                else if(hash === 'students') content = <AdminList type="student" />;
                else if(hash === 'teachers') content = <AdminList type="teacher" />;
                else if(hash === 'subjects') content = <AdminSubjects />;
                else if(hash === 'news') content = <NewsFeed canPost={true} />;
                else if(hash === 'laws') content = <Laws />;
                else content = <AdminDashboard />;
            } else if (user.role === 'teacher') {
                if(hash === 'news') content = <NewsFeed canPost={true} />;
                else if(hash === 'calendar') content = <UserCalendar />;
                else if(hash === 'laws') content = <Laws />;
                else content = <TeacherGrades />;
            } else {
                if(hash === 'grades') content = <StudentGrades />;
                else if(hash === 'profile') content = <StudentProfile />;
                else if(hash === 'laws') content = <Laws />;
                else if(hash === 'calendar') content = <UserCalendar />; // NUEVO PARA ESTUDIANTE
                else if(hash === 'news') content = <NewsFeed canPost={false} />; // NUEVO MENU DE NOTICIAS
                else content = <StudentDashboard />;
            }

            const titleMap = { dashboard: 'Inicio', calendar: 'Mi Calendario', news: 'Cartelera', laws: 'Marco Legal', grades: 'Notas', sections: 'Asignaciones', students: 'Alumnos', teachers: 'Docentes', subjects: 'Materias', profile: 'Mi Perfil' };

            return <DashboardLayout title={titleMap[hash] || 'Panel'} user={user} logout={logout}>{content}</DashboardLayout>;
        };

        const Root = () => (<ErrorBoundary><DataProvider><ToastProvider><AuthProvider><App /></AuthProvider></ToastProvider></DataProvider></ErrorBoundary>);
        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>